#!/bin/sh
# Co-authored-by: Claude <noreply@anthropic.com>

set -e

# Configuration
DYNAMIC_DIR="${DYNAMIC_DIR:-/etc/traefik/dynamic}"
DYNAMIC_CONFIG="${DYNAMIC_DIR}/dynamic.yml"
SERVICES_DIR="${SERVICES_DIR:-/services}"

# Create dynamic directory
mkdir -p "$DYNAMIC_DIR"

# Set default values and export for envsubst
export ACTION_HOST="${ACTION_HOST:-backend}"
export ACTION_PORT="${ACTION_PORT:-9002}"
export PRESENTER_HOST="${PRESENTER_HOST:-backend}"
export PRESENTER_PORT="${PRESENTER_PORT:-9003}"
export AUTOUPDATE_HOST="${AUTOUPDATE_HOST:-autoupdate}"
export AUTOUPDATE_PORT="${AUTOUPDATE_PORT:-9012}"
export ICC_HOST="${ICC_HOST:-icc}"
export ICC_PORT="${ICC_PORT:-9007}"
export AUTH_HOST="${AUTH_HOST:-auth}"
export AUTH_PORT="${AUTH_PORT:-9004}"
export SEARCH_HOST="${SEARCH_HOST:-search}"
export SEARCH_PORT="${SEARCH_PORT:-9050}"
export MEDIA_HOST="${MEDIA_HOST:-media}"
export MEDIA_PORT="${MEDIA_PORT:-9006}"
export MANAGE_HOST="${MANAGE_HOST:-manage}"
export MANAGE_PORT="${MANAGE_PORT:-9008}"
export VOTE_HOST="${VOTE_HOST:-vote}"
export VOTE_PORT="${VOTE_PORT:-9013}"
export CLIENT_HOST="${CLIENT_HOST:-client}"
export CLIENT_PORT="${CLIENT_PORT:-9001}"

# Start building config
cat > "$DYNAMIC_CONFIG" << 'EOF'
http:
  routers:
EOF

# Concatenate all enabled .router files
for service in action presenter autoupdate icc auth search media manage vote client; do
  service_upper=$(echo "$service" | tr '[:lower:]' '[:upper:]')
  host_var="${service_upper}_HOST"

  if env | grep -q "^${host_var}="; then
    eval "echo \"Enabling: $service (\$${host_var})\"" >&2
    envsubst < "$SERVICES_DIR/${service}.router" >> "$DYNAMIC_CONFIG"
  fi
done

# Add services section
cat >> "$DYNAMIC_CONFIG" << 'EOF'

  services:
EOF

# Concatenate all enabled .service files
for service in action presenter autoupdate icc auth search media manage vote client; do
  service_upper=$(echo "$service" | tr '[:lower:]' '[:upper:]')
  host_var="${service_upper}_HOST"

  if env | grep -q "^${host_var}="; then
    envsubst < "$SERVICES_DIR/${service}.service" >> "$DYNAMIC_CONFIG"
  fi
done

# Generate traefik.yml from template
TRAEFIK_CONFIG="${TRAEFIK_CONFIG:-/etc/traefik/traefik.yml}"
export DYNAMIC_DIR
export TRAEFIK_LOG_LEVEL="${TRAEFIK_LOG_LEVEL:-INFO}"
envsubst < /templates/traefik.yml > "$TRAEFIK_CONFIG"

# Handle HTTPS for local development
if [ -n "$ENABLE_LOCAL_HTTPS" ]; then
  HTTPS_CERT_FILE="${HTTPS_CERT_FILE:-/certs/cert.pem}"
  HTTPS_KEY_FILE="${HTTPS_KEY_FILE:-/certs/key.pem}"

  if [ -f "$HTTPS_CERT_FILE" ] && [ -f "$HTTPS_KEY_FILE" ]; then
    export HTTPS_CERT_FILE HTTPS_KEY_FILE
    envsubst < /templates/tls.yml >> "$DYNAMIC_CONFIG"
  else
    echo "ERROR: no local cert-files provided. Did you run make-localhost-cert.sh?"
    exit 1
  fi
fi

exec "$@"
